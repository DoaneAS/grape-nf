#!/bin/bash -eu
samtools view -h -@ ${cpus} ${bam} | \
awk 'BEGIN {OFS="\\t"} {if (\$1!~/^@/ && and(\$2,128)>0) {\$2=xor(\$2,0x10)}; print}' | \
samtools view -@ ${cpus} -Sb - > tmp.bam
mv -f tmp.bam ${bam}

bamtools filter -tag NH:1 -in ${bam} -out tmp.bam && mv -f tmp.bam ${bam}
genomeCoverageBed -strand + -split -bg -ibam ${bam} > ${id}.plusRaw.bedgraph
genomeCoverageBed -strand - -split -bg -ibam ${bam} > ${id}.minusRaw.bedgraph

contigsNew.py --chrFile ${genomeFai} \
              --fileP ${id}.plusRaw.bedgraph \
              --fileM ${id}.minusRaw.bedgraph | \
awk '{s=""; for(i=1; i<=NF; i++){s=(s)(\$i)("\\t")} print s}' > ${id}_contigs.bed