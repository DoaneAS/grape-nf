// main script name
manifest.mainScript = 'grape-pipeline.nf'

//Tools configuration
toolchain  = 'goolf-1.4.10-no-OFED'
python     = 'Python-2.7.3'

//Modules
modules = [
    GEM: [ name: 'GEMtools', version: '1.7.1', suffix: "-${python}" ],
    STAR: [ version: '2.4.0j' ],
    RSEM: [ version: '1.2.15' ],
    SAMtools: [ version: '0.1.19' ],
    pigz: [ version: '2.3.1' ],
    RSeQC: [ version: '2.3.9', suffix: "-${python}" ],
    KentUtils: [ version: '308' ],
    pysam: [ version: '0.8.0', suffix: "-${python}" ],
    BEDTools: [ version: '2.19.1' ],
    BamTools: [ version: '2.3.1' ],
    toolchain: "-${toolchain}"
]

//Strand-view mapping for bigwig step
bwStrandViews = [
    NONE: ['RawSignal','MultipleRawSignal'],
    MATE1_SENSE: ['MinusRawSignal', 'PlusRawSignal', 'MultipleMinusRawSignal','MultiplePlusRawSignal'],
    MATE2_SENSE: ['MinusRawSignal', 'PlusRawSignal', 'MultipleMinusRawSignal','MultiplePlusRawSignal']
]

// Process configuration
process {

    beforeScript = 'module purge'

    executor = 'sge'
    queue    = 'rg-el6,long-sl65'
    penv = 'smp'

    command = {
        cpus = task.cpus
        "${task.process}/${task.tool}${task.profile}"
    }

    profile = '' 
    version = { modules[task.tool].version }    
    modules = { [task.tool] }
    module = { 
        mods = []
        task.modules.each { mods << "${modules[it]?.name ?: it}/${modules[it].version}${modules.toolchain}${modules[it]?.suffix ?: ''}" } 
        mods.join(':')
    }

    errorStrategy = { params?.errorStrategy }
    
    tag = { if (view) id else species }

    $index {
        tool = 'STAR'
        cpus = 4
        memory = '62G'
        time = '24h'
    }
    $t_index {
        tool = 'RSEM'
        cpus = 4
        memory = '15G'
        time = '24h'
    }
    $fastaIndex {
        tool = 'SAMtools'
    }
    $mapping {
        tool = 'STAR'
        readGroup = { readGroupList.collect { it.join(":") }.join(" ") }
        profile = { params.cufflinks ? "-"+params.cufflinks : '' }
        modules = [tool, 'pigz', 'SAMtools']
        cpus = 8
        memory = '62G'
        time = '48h'
    }
    $mergeBam {
        tool = 'SAMtools'
        cpus = 8
        memory = '31G'
    }
    $inferExp {
        tool = 'RSeQC'
        modules = [tool, 'pysam', 'KentUtils']
    }
    $bigwig {
        tool = 'STAR'
        modules = ['SAMtools', 'STAR', 'KentUtils']
        profile = { '-' + readStrand }
        views = {
            bwStrandViews[readStrand]
        }
        cpus = 4
        memory = '15G'
        time = '12h'
    }
    $contig {
        tool = 'CRG'
        profile = { '-' + readStrand }
        modules = ['SAMtools', 'BEDTools', 'BamTools', 'KentUtils']
        cpus = 4
        memory = '31G'
        time = '12h'
    }
    $quantification {
        tool = 'RSEM'
        profile = { '-' + readStrand }
        cpus = 8
        memory = '62G'
        time = '24h'
        type = 'Transcriptome'
    }

}
